<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EV vs. Gas — Monthly Cost</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js + Papa Parse (CDNs) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root { --bg:#fff; --fg:#1f1f33; --muted:#6b6b80; --accent:#5b7cfa; }
    body { font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--fg); background:var(--bg); margin:0; }
    .wrap { max-width: 960px; margin: 32px auto; padding: 0 16px; }
    h1 { margin: 0 0 8px; }
    .panel { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
             padding: 16px; border: 1px solid #ececf5; border-radius: 12px; background:#fafafe;}
    label { font-weight: 600; display: block; margin-bottom: 4px; }
    select, input[type="number"] {
      width: 100%; padding: 10px 12px; border:1px solid #dcdceb; border-radius:10px; background:#fff; color:var(--fg);
    }
    input[type="range"] {
      width: 100%;
    }
    .hint { color: var(--muted); font-size: 13px; margin-top: 4px; }
    canvas { background:#fff; border:1px solid #ececf5; border-radius:12px; padding:8px; }
    
    .advanced-toggle {
      margin: 24px 0 12px;
      padding: 12px 16px;
      background: #f5f5fa;
      border: 1px solid #dcdceb;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .advanced-toggle:hover {
      background: #ececf5;
    }
    .advanced-toggle-title {
      font-weight: 600;
      font-size: 15px;
    }
    .advanced-toggle-arrow {
      transition: transform 0.2s;
      font-size: 18px;
    }
    .advanced-toggle-arrow.open {
      transform: rotate(180deg);
    }
    .advanced-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .advanced-content.open {
      max-height: 500px;
    }
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    .checkbox-container input[type="checkbox"] {
      width: auto;
      cursor: pointer;
    }
    .checkbox-container label {
      margin: 0;
      cursor: pointer;
      font-weight: normal;
    }
    .status {
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Cost of Ownership — EV vs. Gas</h1>
    <p class="hint">Change state and annual miles to see cost comparisons.</p>

    <div id="csvStatus"></div>

    <div class="panel">
      <div>
        <label for="state">State</label>
        <select id="state"></select>
        <div class="hint">Select to get average electricity and gas prices.</div>
      </div>
      <div>
        <label for="miles">Driving Profile</label>
        <select id="miles">
          <option value="">-- Select your driving profile --</option>
          <option value="4000">Minimal (≤5,000 mi/yr) - Walk/transit, short errands, 1-2 days/week</option>
          <option value="7000">Light (5,001-8,000 mi/yr) - Local commute, 2-3 days/week, few trips</option>
          <option value="10000">Typical (8,001-12,000 mi/yr) - Standard usage, 4-5 days/week</option>
          <option value="13000">Heavy Commute (12,001-15,000 mi/yr) - Daily commute, longer drives</option>
          <option value="18000">High Mileage (15,001-20,000+ mi/yr) - Sales/field work, frequent trips</option>
        </select>
        <div class="hint">Select the profile that best matches your driving habits.</div>
      </div>
    </div>

    <div class="advanced-toggle" id="advancedToggle">
      <span class="advanced-toggle-title">⚙️ Advanced Configuration</span>
      <span class="advanced-toggle-arrow">▼</span>
    </div>

    <div class="advanced-content" id="advancedContent">
      <div class="panel">
        <div>
          <label>Need to install EV Charger?</label>
          <div class="checkbox-container">
            <input type="checkbox" id="needsCharger" />
            <label for="needsCharger">Yes</label>
          </div>
        </div>
        <div id="chargerCostContainer" style="display: none;">
          <label for="chargerCost">Charger installation cost ($)</label>
          <input id="chargerCost" type="number" value="1500" min="0" step="100" />
          <div class="hint">Average installation cost: $1,000–$2,500</div>
        </div>
        <div style="grid-column: 1 / -1; height: 1px; background: #dcdceb; margin: 8px 0;"></div>
        <div>
          <label for="homeChargePct">What percentage of charging will you do at home?</label>
          <input id="homeChargePct" type="range" min="0" max="100" value="80" />
          <div class="hint">
            <span id="homeChargePctValue">80</span>% at home, 
            <span id="publicChargePctValue">20</span>% at public stations (charged at $0.50/kWh)
          </div>
        </div>
      </div>
    </div>

    <div style="margin:18px 0;"></div>
    <canvas id="chart" height="140"></canvas>
  </div>

  <script>
    // --- Data storage -------------------------
    let electricityCentsPerKwhByState = {};
    let gasolinePerGallonByState = {};

    // Default assumptions
    const DEFAULTS = {
      evKwhPer100: 28,
      hybridMpg: 50,
      mpg: 30,
      insEV: 140,
      insHybrid: 130,
      insGas: 120,
      maintEV: 25,
      maintHybrid: 45,
      maintGas: 60,
      chargerLifeMonths: 120 // 10 years amortization
    };

    // Build state dropdown
    const stateSel = document.getElementById('state');
    const csvStatus = document.getElementById('csvStatus');
    
    function populateStateDropdown() {
      stateSel.innerHTML = '';
      // Add empty option first
      const emptyOption = document.createElement('option');
      emptyOption.value = '';
      emptyOption.textContent = '-- Select a state --';
      stateSel.appendChild(emptyOption);
      
      const states = Object.keys(electricityCentsPerKwhByState).sort();
      states.forEach(s => {
        const o = document.createElement('option');
        o.value = o.textContent = s;
        stateSel.appendChild(o);
      });
      stateSel.value = '';
    }

    // Automatically load CSV file on page load
    window.addEventListener('DOMContentLoaded', function() {
      const csvFileName = 'state_energy_prices.csv';
      
      csvStatus.innerHTML = '<div class="status">Loading state data...</div>';
      
      Papa.parse(csvFileName, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          console.log('CSV loaded, rows:', results.data.length);
          console.log('Headers:', results.meta.fields);
          
          const newElectricity = {};
          const newGasoline = {};
          let successCount = 0;
          
          results.data.forEach((row, index) => {
            const state = row.state ? row.state.trim() : null;
            
            if (!state || state === '') {
              return;
            }
            
            const elecPrice = parseFloat(row['electricity price']);
            const gasPrice = parseFloat(row['gasoline price']);
            
            if (!isNaN(elecPrice) && !isNaN(gasPrice) && elecPrice > 0 && gasPrice > 0) {
              newElectricity[state] = elecPrice;
              newGasoline[state] = gasPrice;
              successCount++;
              console.log(`Loaded: ${state} - Elec: ${elecPrice}, Gas: ${gasPrice}`);
            } else {
              console.log(`Skipped row ${index}: ${state} - Elec: ${elecPrice}, Gas: ${gasPrice}`);
            }
          });
          
          if (successCount > 0) {
            electricityCentsPerKwhByState = newElectricity;
            gasolinePerGallonByState = newGasoline;
            populateStateDropdown();
            recalc();
            csvStatus.innerHTML = `<div class="status success">✓ Loaded data for ${successCount} states</div>`;
            setTimeout(() => { csvStatus.innerHTML = ''; }, 3000);
          } else {
            csvStatus.innerHTML = '<div class="status error">✗ No valid data found in CSV.</div>';
          }
        },
        error: function(error) {
          csvStatus.innerHTML = `<div class="status error">✗ CSV file not found: ${error.message}</div>`;
          console.error('CSV load error:', error);
        }
      });
    });

    // Advanced toggle
    const advToggle = document.getElementById('advancedToggle');
    const advContent = document.getElementById('advancedContent');
    const advArrow = advToggle.querySelector('.advanced-toggle-arrow');
    
    advToggle.addEventListener('click', () => {
      advContent.classList.toggle('open');
      advArrow.classList.toggle('open');
    });

    // Charger checkbox toggle
    const needsCharger = document.getElementById('needsCharger');
    const chargerCostContainer = document.getElementById('chargerCostContainer');
    
    needsCharger.addEventListener('change', () => {
      chargerCostContainer.style.display = needsCharger.checked ? 'block' : 'none';
      recalc();
    });

    // Slider display
    const homeSlider = document.getElementById('homeChargePct');
    const homeVal = document.getElementById('homeChargePctValue');
    const publicVal = document.getElementById('publicChargePctValue');
    
    homeSlider.addEventListener('input', () => {
      const val = homeSlider.value;
      homeVal.textContent = val;
      publicVal.textContent = 100 - val;
      recalc();
    });

    // --- Core formulas --------------------------------------------------------
    function monthlyCosts({
      state, annualMiles, needsCharger, chargerCost, homeChargePct
    }) {
      const homeKwhPrice = (electricityCentsPerKwhByState[state] ?? 15) / 100; // $/kWh
      const gasPrice = gasolinePerGallonByState[state] ?? 3.5; // $/gal
      const publicChargeRate = 0.50; // Fixed rate for public charging

      // EV charging calculation
      const ev_kwh_year = (DEFAULTS.evKwhPer100 / 100) * annualMiles;
      const homeChargeFraction = homeChargePct / 100;
      const publicChargeFraction = 1 - homeChargeFraction;
      
      const homeChargeYear = ev_kwh_year * homeChargeFraction * homeKwhPrice;
      const publicChargeYear = ev_kwh_year * publicChargeFraction * publicChargeRate;
      const evFuelYear = homeChargeYear + publicChargeYear;

      // Hybrid calculation
      const hybrid_gal_year = annualMiles / DEFAULTS.hybridMpg;
      const hybridFuelYear = hybrid_gal_year * gasPrice;

      // Gas calculation
      const gas_gal_year = annualMiles / DEFAULTS.mpg;
      const gasFuelYear = gas_gal_year * gasPrice;

      // Monthly costs
      const evFuelMonth = evFuelYear / 12;
      const hybridFuelMonth = hybridFuelYear / 12;
      const gasFuelMonth = gasFuelYear / 12;

      // Add charger cost if needed
      const chargerMonthly = needsCharger ? chargerCost / DEFAULTS.chargerLifeMonths : 0;

      const evTotal = evFuelMonth + DEFAULTS.insEV + DEFAULTS.maintEV + chargerMonthly;
      const hybridTotal = hybridFuelMonth + DEFAULTS.insHybrid + DEFAULTS.maintHybrid;
      const gasTotal = gasFuelMonth + DEFAULTS.insGas + DEFAULTS.maintGas;

      return { evFuelMonth, hybridFuelMonth, gasFuelMonth, evTotal, hybridTotal, gasTotal, chargerMonthly };
    }

    // --- Chart setup ----------------------------------------------------------
    const ctx = document.getElementById('chart');
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['EV','Hybrid','Gasoline'],
        datasets: [
          { label:'Fuel/Charge', data:[0,0,0], backgroundColor:'#7c6cf3' },
          { label:'Insurance',   data:[0,0,0], backgroundColor:'#b9a7ff' },
          { label:'Maintenance', data:[0,0,0], backgroundColor:'#e1d8ff' },
          { label:'Charger (amortized)', data:[0,0,0], backgroundColor:'#ffa07a' }
        ]
      },
      options: {
        responsive:true,
        scales: {
          x: { stacked:true },
          y: { stacked:true, beginAtZero:true, title:{ display:true, text:'$/month'} }
        },
        plugins: {
          legend: { position:'bottom' },
          tooltip: { mode:'index', intersect:false }
        }
      }
    });

    // --- Bind inputs & update loop -------------------------------------------
    const $ = id => document.getElementById(id);
    const inputs = ['state','miles','needsCharger','chargerCost','homeChargePct'].map($);

    function fmt(n){ return '

      // Update stacked bars
      chart.data.datasets[0].data = [result.evFuelMonth, result.hybridFuelMonth, result.gasFuelMonth];
      chart.data.datasets[1].data = [DEFAULTS.insEV, DEFAULTS.insHybrid, DEFAULTS.insGas];
      chart.data.datasets[2].data = [DEFAULTS.maintEV, DEFAULTS.maintHybrid, DEFAULTS.maintGas];
      chart.data.datasets[3].data = [result.chargerMonthly, 0, 0];
      chart.update();
    }
    
    inputs.forEach(el => el.addEventListener('input', recalc));
    inputs.forEach(el => el.addEventListener('change', recalc));
    
    // Initial calculation
    if (Object.keys(electricityCentsPerKwhByState).length > 0) {
      recalc();
    }
  </script>
</body>
</html> + n.toFixed(0); }

    function recalc() {
      // Check if both state and miles are selected
      if (!$('state').value || !$('miles').value) {
        // Don't calculate if required fields are empty
        return;
      }
      
      const result = monthlyCosts({
        state: $('state').value,
        annualMiles: +$('miles').value,
        needsCharger: $('needsCharger').checked,
        chargerCost: +$('chargerCost').value,
        homeChargePct: +$('homeChargePct').value
      });

      // Update stacked bars
      chart.data.datasets[0].data = [result.evFuelMonth, result.hybridFuelMonth, result.gasFuelMonth];
      chart.data.datasets[1].data = [DEFAULTS.insEV, DEFAULTS.insHybrid, DEFAULTS.insGas];
      chart.data.datasets[2].data = [DEFAULTS.maintEV, DEFAULTS.maintHybrid, DEFAULTS.maintGas];
      chart.data.datasets[3].data = [result.chargerMonthly, 0, 0];
      chart.update();
    }
    
    inputs.forEach(el => el.addEventListener('input', recalc));
    inputs.forEach(el => el.addEventListener('change', recalc));
    
    // Initial calculation
    if (Object.keys(electricityCentsPerKwhByState).length > 0) {
      recalc();
    }
  </script>
</body>
</html>
