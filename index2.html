<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EV vs. Gas — Monthly Cost</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js + Papa Parse (CDNs) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root { --bg:#fff; --fg:#1f1f33; --muted:#6b6b80; --accent:#5b7cfa; }
    body { font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--fg); background:var(--bg); margin:0; }
    .wrap { max-width: 960px; margin: 32px auto; padding: 0 16px; }
    h1 { margin: 0 0 8px; }
    .panel { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
             padding: 16px; border: 1px solid #ececf5; border-radius: 12px; background:#fafafe;}
    label { font-weight: 600; display: block; margin-bottom: 4px; }
    select, input[type="number"] {
      width: 100%; padding: 10px 12px; border:1px solid #dcdceb; border-radius:10px; background:#fff; color:var(--fg);
    }
    input[type="range"] { width: 100%; }
    .hint { color: var(--muted); font-size: 13px; margin-top: 4px; }
    canvas { background:#fff; border:1px solid #ececf5; border-radius:12px; padding:8px; }

    .advanced-toggle {
      margin: 24px 0 12px; padding: 12px 16px; background:#f5f5fa; border:1px solid #dcdceb;
      border-radius:10px; cursor:pointer; user-select:none; display:flex; align-items:center; justify-content:space-between;
    }
    .advanced-toggle:hover { background:#ececf5; }
    .advanced-toggle-title { font-weight:600; font-size:15px; }
    .advanced-toggle-arrow { transition: transform 0.2s; font-size:18px; }
    .advanced-toggle-arrow.open { transform: rotate(180deg); }
    .advanced-content { max-height:0; overflow:hidden; transition:max-height 0.3s ease-out; }
    .advanced-content.open { max-height:500px; }
    .checkbox-container { display:flex; align-items:center; gap:8px; margin-top:8px; }
    .checkbox-container input[type="checkbox"] { width:auto; cursor:pointer; }
    .checkbox-container label { margin:0; cursor:pointer; font-weight:normal; }
    .status { padding:8px 12px; border-radius:8px; font-size:14px; margin-bottom:16px; }
    .status.success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .status.error   { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Cost of Ownership — EV vs. Gas</h1>
    <p class="hint">Change state and annual miles to see cost comparisons.</p>

    <div id="csvStatus"></div>

    <div class="panel">
      <div>
        <label for="state">State</label>
        <select id="state"></select>
        <div class="hint">Select to get average electricity and gas prices.</div>
      </div>
      <div>
        <label for="miles">Driving Profile</label>
        <select id="miles">
          <option value="">-- Select your driving profile --</option>
          <option value="4000">Minimal (≤5,000 mi/yr) - Walk/transit, short errands, 1-2 days/week</option>
          <option value="7000">Light (5,001-8,000 mi/yr) - Local commute, 2-3 days/week, few trips</option>
          <option value="10000">Typical (8,001-12,000 mi/yr) - Standard usage, 4-5 days/week</option>
          <option value="13000">Heavy Commute (12,001-15,000 mi/yr) - Daily commute, longer drives</option>
          <option value="18000">High Mileage (15,001-20,000+ mi/yr) - Sales/field work, frequent trips</option>
        </select>
        <div class="hint">Select the profile that best matches your driving habits.</div>
      </div>
    </div>

    <div class="advanced-toggle" id="advancedToggle">
      <span class="advanced-toggle-title">⚙️ Advanced Configuration</span>
      <span class="advanced-toggle-arrow">▼</span>
    </div>

    <div class="advanced-content" id="advancedContent">
      <div class="panel">
        <div>
          <label>Need to install EV Charger?</label>
          <div class="checkbox-container">
            <input type="checkbox" id="needsCharger" />
            <label for="needsCharger">Yes</label>
          </div>
        </div>
        <div id="chargerCostContainer" style="display:none;">
          <label for="chargerCost">Charger installation cost ($)</label>
          <input id="chargerCost" type="number" value="1500" min="0" step="100" />
          <div class="hint">Average installation cost: $1,000–$2,500</div>
        </div>
        <div style="grid-column:1/-1; height:1px; background:#dcdceb; margin:8px 0;"></div>
        <div>
          <label for="homeChargePct">What percentage of charging will you do at home?</label>
          <input id="homeChargePct" type="range" min="0" max="100" value="80" />
          <div class="hint">
            <span id="homeChargePctValue">80</span>% at home,
            <span id="publicChargePctValue">20</span>% at public stations (charged at $0.50/kWh)
          </div>
        </div>
      </div>
    </div>

    <div style="margin:18px 0;"></div>
    <canvas id="chart" height="140"></canvas>
  </div>

  <script>
    // ---------------- Data & defaults ----------------
    let electricityCentsPerKwhByState = {};
    let gasolinePerGallonByState = {};

    const DEFAULTS = {
      evKwhPer100: 28,
      hybridMpg: 50,
      mpg: 30,
      insEV: 140,
      insHybrid: 130,
      insGas: 120,
      maintEV: 25,
      maintHybrid: 45,
      maintGas: 60,
      chargerLifeMonths: 120 // 10 years
    };

    const $ = id => document.getElementById(id);

    // ---------------- State dropdown ----------------
    function populateStateDropdown() {
      const sel = $('state');
      sel.innerHTML = '';
      const emptyOption = document.createElement('option');
      emptyOption.value = '';
      emptyOption.textContent = '-- Select a state --';
      sel.appendChild(emptyOption);

      const states = Object.keys(electricityCentsPerKwhByState).sort();
      states.forEach(s => {
        const o = document.createElement('option');
        o.value = o.textContent = s;
        sel.appendChild(o);
      });
      sel.value = '';
    }

    // ---------------- CSV load ----------------
    const csvStatus = $('csvStatus');

    window.addEventListener('DOMContentLoaded', function() {
      const csvFileName = 'state_energy_prices.csv';
      csvStatus.innerHTML = '<div class="status">Loading state data...</div>';

      Papa.parse(csvFileName, {
        download: true,
        header: true,
        skipEmptyLines: true,
        transformHeader: h => h.replace(/^\uFEFF/, '').trim(), // strip BOM + trim
        complete: function(results) {
          const newElectricity = {};
          const newGasoline = {

            
