<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>True Price of Going Electric</title>

    <!-- Chart.js + Papa Parse (CDNs) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
        }

        .hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 80px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: "";
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h100v100H0z' fill='none'/%3E%3Cpath d='M50 10v80M10 50h80' stroke='rgba(255,255,255,0.1)' stroke-width='0.5'/%3E%3C/svg%3E");
            opacity: 0.3;
        }

        .hero h1 {
            font-size: 3em;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .hero p {
            font-size: 1.3em;
            max-width: 950px;
            margin: 0 auto;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            text-align: left;
        }

        .container {
            max-width: 950px;
            margin: 0 auto;
            padding: 0px;
        }

        .section {
            margin: 80px 0;
            opacity: 0;
            transform: translateY(30px);
            animation: fadeInUp 0.8s ease forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section:nth-child(2) { animation-delay: 0.2s; }
        .section:nth-child(3) { animation-delay: 0.4s; }
        .section:nth-child(4) { animation-delay: 0.6s; }
        .section:nth-child(5) { animation-delay: 0.8s; }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            gap: 20px;
        }

        .section-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .section h2 {
            font-size: 2em;
            color: #2d3748;
            flex: 1;
        }

        .section p {
            font-size: 1.15em;
            color: #4a5568;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        .chart-placeholder {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            margin: 10px 0;
            border: 2px dashed #ffffff;
            text-align: center;
            color: #718096;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            transition: all 0.3s ease;
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
        }

        .chart-placeholder img {
            max-width: 850px;
            height: auto;
            margin: 0 auto;
            display: block;
            padding: 5px 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin: 40px 0;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
        }

        .stat-card h4 {
            color: #667eea;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 0.95em;
            color: #718096;
            margin: 0;
        }

        .calculator-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 20px;
            border-radius: 20px;
            margin: 80px 0;
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.3);
        }

        .calculator-section h2 {
            color: white;
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .calculator-section > p {
            text-align: center;
            font-size: 1.2em;
            max-width: 700px;
            margin: 0 auto 40px;
            opacity: 0.95;
        }

        .calculator-placeholder {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            padding: 20px;
            color: #1a202c;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .calculator-placeholder h3 {
            margin-bottom: 4px;
            font-size: 1.4em;
            color: #2d3748;
        }

        .calculator-subtitle {
            font-size: 0.95em;
            color: #718096;
            margin-bottom: 10px;
        }

        .panel {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            padding: 16px;
            border: 1px solid #ececf5;
            border-radius: 12px;
            background: #fafafe;
        }

        label {
            font-weight: 650;
            display: block;
            margin-bottom: 4px;
            size: 24;
        }

        select,
        input[type="number"] {
            width: 100%;
            padding: 15px 12px;
            border: 1px solid #dcdceb;
            border-radius: 10px;
            background: #fff;
            color: #1f1f33;
            font-size: large;
        }

        input[type="range"] {
            width: 100%;
        }

        .hint {
            color: #6b6b80;
            font-size: 13px;
            margin-top: 4px;
        }

        canvas {
            background: #fff;
            border: 1px solid #ececf5;
            border-radius: 12px;
            padding: 8px;
        }

        #chart {
            width: 100%;
            height: 450px;
            max-height: 450px;
        }

        .radio-container {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .radio-option input[type="radio"] {
            width: auto;
            cursor: pointer;
        }

        .radio-option label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }

        .status {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .vehicle-image {
            width: 100%;
            max-width: 400px;
            height: 150px;
            object-fit: contain;
            border-radius: 8px;
            background: #ffffff;
            margin-top: 12px;
            border: 1px solid #dcdceb;
        }

        footer {
            background: #2d3748;
            color: white;
            text-align: center;
            padding: 40px 20px;
            margin-top: 80px;
        }

        footer p {
            opacity: 0.8;
            margin: 0;
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2em;
            }

            .hero p {
                font-size: 1.1em;
            }

            .section h2 {
                font-size: 1.5em;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .calculator-section h2 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="hero">
        <h1>The True Price of Going Electric</h1>
        <br>
        <p>Electric Vehicles (EV) are often marketed as cleaner and more cost efficient, but the real story depends on several factors. 
This page shows what actually powers an EV, how electricity and gasoline prices vary by state, and how insurance can change the final math.</p>
    </div>

    <div class="container">
        <!-- Section 1 -->
        <div class="section">
            <div class="section-header">
                <div class="section-number">1</div>
                <h2>EV 101: How EVs Work</h2>
            </div>
            
            <p>An electric vehicle (EV) uses an electric motor instead of an engine powered by a large battery. 
                That battery has to be charged, just like your phone by plugging into an outlet. 
                But an <strong>EV battery is much larger than a phone battery</strong>, so it takes longer to charge and uses much more electricity, 
                which is billed in kilowatt-hours (kWh).</p>
            <p>Most electric vehicles have a battery capacity between 60 and 75 kWh. That‚Äôs roughly the same as the 
                combined battery size of about 5,000 iPhones. Fully charging an EV battery with typical residential electricity 
                costs around $10, which is much cheaper than filling up with gasoline. 
                This cost gap is one of the biggest advantages of driving an EV.</p>
            <br>
            <div class="chart-placeholder">
                <p>
                    <img src="EV_Scale.png">
                </p>
            </div>
        </div>
       <br>
        <!-- Section 2 -->
        <div class="section">
            <div class="section-header">
                <div class="section-number">2</div>
                <h2>The Myth of "EVs Are Cleaner"</h2>
            </div>
            <p>Electric vehicles are often marketed as cleaner and cheaper to run than gasoline cars. 
                The idea sounds simple: The energy used to charge the vehicle looks green. 
                But in the U.S., <strong>a major share of the electricity used to charge EVs still comes from fossil fuels</strong>, 
                so in many places the energy behind the plug is not as clean as the marketing suggests.</p>
            <br>            
            <div class="chart-placeholder">
                <p><br>
                    <img src="EVSource.png">
                </p>
            </div>
        </div>
        <br>
        <!-- Section 3 -->
        <div class="section">
            <div class="section-header">
                <div class="section-number">3</div>
                <h2>Energy Costs Vary Wildly by State</h2>
            </div>
            <p>When you look at the data, one pattern becomes immediately clear: <strong>electricity and gas prices change dramatically across state lines</strong>. Some states offer incredibly cheap electricity, making EV charging a bargain. Others have high electricity rates that diminish the cost advantage significantly.</p>
            <p>The same volatility applies to gasoline. While everyone experiences price fluctuations at the pump, the baseline price per gallon varies considerably by region due to state taxes, local regulations, and distribution costs.</p>
            <br>
            <div class="chart-placeholder">
                <p><br>
                    <img src="Average%20Electricity%20Price2.png" alt="Average electricity price map">
                    <br><br>
                    <img src="Average%20Gas%20Price2.png" alt="Average gas price map">
                </p>
            </div>
        </div>
        <br>
        <!-- Section 4 -->
        <div class="section">
            <div class="section-header">
                <div class="section-number">4</div>
                <h2>Insurance Complicates the Story</h2>
            </div>
            <p>Even when energy costs still favor EVs, there's another expense that often gets overlooked in basic comparisons: <strong>insurance premiums</strong>.
            EV insurance tends to run higher than comparable vehicles due to specialized parts, expensive battery repairs, and the need for authentic OEM parts for many repairs.</p>
            <br>
            <div class="chart-placeholder">
                <br>
                <p><img src="InsuranceChart2.png" alt="Insurance comparison chart"></p>
            </div>
            <br><br>
            <p>By looking at the average annual insurance rates for each body type among the top 50 models, 
                we can see that <strong>EVs consistently cost more to insure than comparable non-electric vehicles </strong> of the same body type. 
                The gap between EV and non-EV premiums is large enough that it can wipe out much of the savings from cheaper electricity.</p>
            <br>
            <div class="chart-placeholder">
                <br>
                <p><img src="EVInsurance.png" alt="Insurance comparison chart"></p>
            </div>
        </div>
        <br>
        <!-- Section 5 - Calculator -->
        <div class="section">
            <div class="section-header">
                <div class="section-number">5</div>
                <h2>The True Cost of Car Ownership</h2>
            </div>
            <p>Based on everything above, this calculator estimates what an EV, hybrid, and gasoline vehicle would actually cost you each month. Adjust the inputs to see how your driving habits and location change the true cost of each option.</p>
            <div class="calculator-placeholder">
                <!-- <div id="csvStatus"></div> -->
                <div class="panel">
                    <div>
                        <label for="state">Select your state of residence</label>
                        <select id="state"></select>
                    </div>
             
                    <div>
                        <label for="miles">Choose your driving profile</label>
                        <select id="miles">
                            <option value="">Select your driving profile --</option>
                            <option value="5000">Minimal (5,000 miles/yr) 1~2 days/week</option>
                            <option value="7000">Light (7,000 miles/yr) 2~3 days/week</option>
                            <option value="10000">Typical (10,000 miles/yr) 4~5 days/week</option>
                            <option value="13000">Heavy Commute (13,000 miles/yr) Daily commute</option>
                            <option value="18000">High Mileage (18,000 miles/yr) Frequent trips</option>
                        </select>
                    </div>
                </div>

                <div class="panel">
                    <div>
                        <label>Choose your EV</label>
                        <!--<div class="hint">Choose your electric vehicle.</div>-->
                        <select id="evModel">
                            <option value="Model 3">Tesla Model 3</option>
                            <option value="Model Y" selected>Tesla Model Y</option>
                            <option value="Model S">Tesla Model S</option>
                            <option value="Model X">Tesla Model X</option>
                        </select>
                        <img id="evImage" class="vehicle-image" src="https://via.placeholder.com/300x150/7c6cf3/ffffff?text=Tesla+Model+Y" alt="EV" width=100%>
                    </div>

                    <div>
                        <label>Choose your Hybrid Vehicle</label>
                        <!-- <div class="hint">Choose your hybrid vehicle.</div>-->
                        <select id="hybridModel">
                            <option value="Toyota Prius" selected>Toyota Prius</option>
                            <option value="Toyota RAV4 Hybrid">Toyota RAV4 Hybrid</option>
                            <option value="Honda Accord Hybrid">Honda Accord Hybrid</option>
                            <option value="Toyota Camry Hybrid">Toyota Camry Hybrid</option>
                            <option value="Toyota Highlander Hybrid">Toyota Highlander Hybrid</option>
                        </select>
                        <img id="hybridImage" class="vehicle-image" src="https://via.placeholder.com/300x150/b9a7ff/ffffff?text=Toyota+Prius" alt="Hybrid" width=100%>
                    </div>

                    <div>
                        <label>Choose your Gasoline Vehicle</label>
                        <!--<div class="hint">Choose your gasoline vehicle.</div>-->
                        <select id="gasModel">
                            <option value="Honda Civic" selected>Honda Civic</option>
                            <option value="Honda CR-V">Honda CR-V</option>
                            <option value="Toyota Camry">Toyota Camry</option>
                            <option value="Toyota RAV4">Toyota RAV4</option>
                            <option value="Chevy Equinox">Chevy Equinox</option>
                        </select>
                        <img id="gasImage" class="vehicle-image" src="https://via.placeholder.com/300x150/e1d8ff/ffffff?text=Honda+Civic" alt="Gas" width=100%>
                    </div>
                </div>

                <div class="panel">
                    <div>
                        <label>Do you need to install a home EV charger?</label>
                        <div class="radio-container">
                            <div class="radio-option">
                                <input type="radio" id="needsChargerYes" name="needsCharger" value="yes">
                                <label for="needsChargerYes">Yes</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="needsChargerNo" name="needsCharger" value="no" checked>
                                <label for="needsChargerNo">No</label>
                            </div>
                        </div>
                        <div class="hint">If yes, we‚Äôll just add about $1,500 over the next 10 years.</div>
                    </div>

                    <div>
                        <label for="homeChargePct">Percent of your charging done at home</label>
                        <input id="homeChargePct" type="range" min="0" max="100" value="80">
                        <div class="hint">
                            <span id="homeChargePctValue">80</span>% at home,
                            <span id="publicChargePctValue">20</span>% at public chargers (assumed $0.50/kWh)
                        </div>
                    </div>
                </div>
                <br>
                <label>Monthly Cost by Vehicle Type ($/month)</label>
                <canvas id="chart" height="450"></canvas>
                
                <div class="hint">
                    <strong>Disclaimer:</strong> Estimates are based on publicly available data. Actual electricity/gas prices may vary, 
                    and insurance premiums depend on factors like age, driving history, and coverage. Taxes, registration, and fees are not included. This information is provided for reference only.
                </div>
            </div>
        </div>
        <br>
        <!-- Bottom line -->
        <div class="section">
            <h2 style="text-align: center; color: #2d3748; margin-bottom: 30px;">The Bottom Line</h2>
            <p style="text-align: left; font-size: 1.2em; margin: 0 auto;">
                There isn‚Äôt a simple answer to whether an EV is always the ‚Äúbetter‚Äù option. 
                Many EVs do come with futuristic design and impressive performance, but when it comes to cost, 
                it depends on where you live, how much you drive, and what you‚Äôll pay for insurance. 
                By bringing these pieces together, this tool gives you an estimated cost so you can make a smarter, more informed decision in the future.
            </p>
        </div>
    </div>

    <footer>
        <p>Data-driven insights on "True Price of Going Electric" | MICA DAV Capstone Project 2025</p>
    </footer>

    <script>
        // ---------- Constants & defaults ----------
        const CHARGER_COST = 1500;
        let electricityCentsPerKwhByState = {};
        let gasolinePerGallonByState = {};

        const DEFAULTS = {
            evKwhPer100: 28,
            hybridMpg: 50,
            mpg: 30,
            insTesla3: 358,
            insTeslaY: 333.6,
            insTeslaS: 309.8,
            insTeslaX: 355.8,
            insPrius: 182.7,
            insRAV4H: 171.5,
            insAccordH: 199.2,
            insCamryH: 226.2,
            insHighlanderH: 176.9,
            insCivic: 207.7,
            insCRV: 160.1,
            insCamry: 226.2,
            insRAV4: 171.5,
            insEquinox: 173.3,
            insEV: 200,          // fallback average EV insurance (monthly)
            insHybrid: 130,
            insGas: 120,
            maintEV: 35,
            maintHybrid: 50,
            maintGas: 60,
            chargerLifeMonths: 120 // 10 years
        };

        // Vehicle image URLs
        const VEHICLE_IMAGES = {
            'Model 3': 'Model-3.png',
            'Model Y': 'Model-Y.png',
            'Model S': 'Model-S.png',
            'Model X': 'Model-X.png',
            'Toyota Prius': 'Toyota_Prius.png',
            'Toyota RAV4 Hybrid': 'RAV-4.png',
            'Toyota RAV4': 'RAV4.png',
            'Honda Accord Hybrid': 'Accord-Hybrid.png',
            'Toyota Camry Hybrid': 'Camry-Hybrid.png',
            'Toyota Camry': 'Camry-Hybrid.png',
            'Toyota Highlander Hybrid': 'Highlander-Hybrid.png',
            'Honda Civic': 'Honda_Civic.png',
            'Honda CR-V': 'CR-V.png',
            'Chevy Equinox': 'Equinox.png'
        };

        const $ = id => document.getElementById(id);
        const csvStatus = $('csvStatus');
        const stateSel = $('state');

        // ---------- Build state dropdown ----------
        function populateStateDropdown() {
            stateSel.innerHTML = '';
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'Select a state --';
            stateSel.appendChild(emptyOption);

            Object.keys(electricityCentsPerKwhByState).sort().forEach(s => {
                const o = document.createElement('option');
                o.value = o.textContent = s;
                stateSel.appendChild(o);
            });
            stateSel.value = '';
        }

        // ---------- Update vehicle images ----------
        function updateVehicleImages() {
            const evModel = $('evModel').value;
            const hybridModel = $('hybridModel').value;
            const gasModel = $('gasModel').value;

            $('evImage').src = VEHICLE_IMAGES[evModel] || VEHICLE_IMAGES['Model Y'];
            $('hybridImage').src = VEHICLE_IMAGES[hybridModel] || VEHICLE_IMAGES['Toyota Prius'];
            $('gasImage').src = VEHICLE_IMAGES[gasModel] || VEHICLE_IMAGES['Honda Civic'];
        }

        // ---------- CSV load ----------
        window.addEventListener('DOMContentLoaded', function () {
            const csvFileName = 'state_energy_prices.csv';
            if (csvStatus) {
                csvStatus.innerHTML = '<div class="status">Loading state data...</div>';
            }

            Papa.parse(csvFileName, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    const newElectricity = {};
                    const newGasoline = {};
                    let successCount = 0;

                    results.data.forEach(row => {
                        const state = row.state ? String(row.state).trim() : '';
                        if (!state) return;

                        const elecPrice = parseFloat(row['electricity price']);
                        const gasPrice = parseFloat(row['gasoline price']);

                        if (Number.isFinite(elecPrice) && elecPrice > 0 &&
                            Number.isFinite(gasPrice) && gasPrice > 0) {
                            newElectricity[state] = elecPrice;
                            newGasoline[state] = gasPrice;
                            successCount++;
                        }
                    });

                    if (successCount > 0) {
                        electricityCentsPerKwhByState = newElectricity;
                        gasolinePerGallonByState = newGasoline;
                        populateStateDropdown();
                        if (csvStatus) {
                            csvStatus.innerHTML = '<div class="status success">‚úì Loaded data for ' + successCount + ' states</div>';
                            setTimeout(() => { csvStatus.innerHTML = ''; }, 2500);
                        }
                    } else if (csvStatus) {
                        csvStatus.innerHTML = '<div class="status error">‚úó No valid data found in CSV.</div>';
                    }

                    // Initialize vehicle images
                    updateVehicleImages();
                    recalc();
                },
                error: function (error) {
                    if (csvStatus) {
                        csvStatus.innerHTML = '<div class="status error">‚úó CSV file not found: ' + error.message + '</div>';
                    }
                    console.error('CSV load error:', error);
                    updateVehicleImages();
                    recalc();
                }
            });
        });

        // ---------- Radio bindings ----------
        const needsChargerYes = $('needsChargerYes');
        const needsChargerNo = $('needsChargerNo');
        needsChargerYes.addEventListener('change', recalc);
        needsChargerNo.addEventListener('change', recalc);

        // ---------- Slider bindings ----------
        const homeSlider = $('homeChargePct');
        const homeVal = $('homeChargePctValue');
        const publicVal = $('publicChargePctValue');
        homeSlider.addEventListener('input', () => {
            const v = parseInt(homeSlider.value, 10) || 0;
            homeVal.textContent = v;
            publicVal.textContent = 100 - v;
            recalc();
        });

        // ---------- Math ----------
        function monthlyCosts({ state, annualMiles, needsCharger, homeChargePct }) {
            const homeKwhPrice = (electricityCentsPerKwhByState[state] ?? 15) / 100; // default 15¬¢/kWh
            const gasPrice = gasolinePerGallonByState[state] ?? 3.5;                 // default $3.50/gal
            const publicChargeRate = 0.50; // $/kWh

            const ev_kwh_year = (DEFAULTS.evKwhPer100 / 100) * annualMiles;
            const homeFrac = homeChargePct / 100;
            const publicFrac = 1 - homeFrac;

            const homeChargeYear = ev_kwh_year * homeFrac * homeKwhPrice;
            const publicChargeYear = ev_kwh_year * publicFrac * publicChargeRate;
            const evFuelYear = homeChargeYear + publicChargeYear;

            const hybridFuelYear = (annualMiles / DEFAULTS.hybridMpg) * gasPrice;
            const gasFuelYear = (annualMiles / DEFAULTS.mpg) * gasPrice;

            const evFuelMonth = evFuelYear / 12;
            const hybridFuelMonth = hybridFuelYear / 12;
            const gasFuelMonth = gasFuelYear / 12;

            const chargerMonthly = needsCharger ? (CHARGER_COST / DEFAULTS.chargerLifeMonths) : 0;

            // Dynamic maintenance based on miles
            const BASE_MILES = 12000; // assume defaults are for 12k miles/year
            const milesFactor = BASE_MILES ? (annualMiles / BASE_MILES) : 0;

            const evMaintMonth = DEFAULTS.maintEV * milesFactor;
            const hybridMaintMonth = DEFAULTS.maintHybrid * milesFactor;
            const gasMaintMonth = DEFAULTS.maintGas * milesFactor;

            return {
                evFuelMonth,
                hybridFuelMonth,
                gasFuelMonth,
                chargerMonthly,
                evMaintMonth,
                hybridMaintMonth,
                gasMaintMonth
            };
        }

        // ---------- Chart ----------
        const ctx = document.getElementById('chart');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['EV', 'Hybrid', 'Gasoline'],
                datasets: [
                    { label: 'Fuel/Charge', data: [0, 0, 0], backgroundColor: '#4060a5', categoryPercentage: 0.97 },
                    { label: 'Insurance', data: [0, 0, 0], backgroundColor: '#7a93c9' , categoryPercentage: .97},
                    { label: 'Maintenance', data: [0, 0, 0], backgroundColor: '#cde1ec' , categoryPercentage: .97},
                    { label: 'Charger', data: [0, 0, 0], backgroundColor: '#d0d0d0' , categoryPercentage: .97}                    
                  ]
            },
            plugins: [ChartDataLabels],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { top: 30 } }, // room for labels above bars
                scales: {
                    x: {
                        stacked: true,
                        grid: { display: false },
                        border: { display: false },
                        ticks: {
                            font: {
                                size: 16,
                                weight: '600'
                            }
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        display: false,
                        grid: { display: false },
                        border: { display: false }
                    }
                },
                plugins: {
                    legend: { 
                            position: 'bottom', 
                            reverse: true   // üëà this flips the legend order
                            },
                    tooltip: { 
                            mode: 'index',
                            reverse: true,
                            intersect: false 
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        formatter: (value, context) => {
                            const datasets = context.chart.data.datasets;
                            const lastDatasetIndex = datasets.length - 1;
                            if (context.datasetIndex !== lastDatasetIndex) return '';

                            const dataIndex = context.dataIndex;
                            let total = 0;
                            datasets.forEach(ds => {
                                const v = ds.data[dataIndex];
                                if (typeof v === 'number' && !isNaN(v)) total += v;
                            });
                            return `$${total.toFixed(0)}`;
                        },
                        clamp: true,
                        // Label above chart
                        font: { 
                            size: 16,
                            weight: '600' 
                        }
                    }
                }
            }
        });

        // ---------- Get insurance for selected vehicles ----------
        function getInsuranceByModel() {
            const evModel = $('evModel').value;
            const hybridModel = $('hybridModel').value;
            const gasModel = $('gasModel').value;

            const insuranceMap = {
                'Model 3': DEFAULTS.insTesla3,
                'Model Y': DEFAULTS.insTeslaY,
                'Model S': DEFAULTS.insTeslaS,
                'Model X': DEFAULTS.insTeslaX,

                // Hybrids
                'Toyota Prius': DEFAULTS.insPrius,
                'Toyota RAV4 Hybrid': DEFAULTS.insRAV4H,
                'Honda Accord Hybrid': DEFAULTS.insAccordH,
                'Toyota Camry Hybrid': DEFAULTS.insCamryH,
                'Toyota Highlander Hybrid': DEFAULTS.insHighlanderH,

                // Gas
                'Honda Civic': DEFAULTS.insCivic,
                'Honda CR-V': DEFAULTS.insCRV,
                'Toyota Camry': DEFAULTS.insCamry,
                'Toyota RAV4': DEFAULTS.insRAV4,
                'Chevy Equinox': DEFAULTS.insEquinox
            };

            return {
                evIns: insuranceMap[evModel] || DEFAULTS.insEV,
                hybridIns: insuranceMap[hybridModel] || DEFAULTS.insHybrid,
                gasIns: insuranceMap[gasModel] || DEFAULTS.insGas
            };
        }

        // ---------- Recalc ----------
        function recalc() {
            const state = $('state').value;
            const miles = parseInt($('miles').value, 10) || 0;

            const result = monthlyCosts({
                state,
                annualMiles: miles,
                needsCharger: $('needsChargerYes').checked,
                homeChargePct: parseInt($('homeChargePct').value, 10) || 0
            });

            if (state && miles) {
                chart.data.datasets[0].data = [
                    result.evFuelMonth,
                    result.hybridFuelMonth,
                    result.gasFuelMonth
                ];
                chart.data.datasets[3].data = [result.chargerMonthly, 0, 0];
            } else {
                chart.data.datasets[0].data = [0, 0, 0];
                chart.data.datasets[3].data = [0, 0, 0];
            }

            const insurance = getInsuranceByModel();
            chart.data.datasets[1].data = [
                insurance.evIns,
                insurance.hybridIns,
                insurance.gasIns
            ];

            chart.data.datasets[2].data = [
                result.evMaintMonth,
                result.hybridMaintMonth,
                result.gasMaintMonth
            ];

            chart.update();
        }

        // ---------- Bind events ----------
        ['state', 'miles', 'homeChargePct', 'evModel', 'hybridModel', 'gasModel'].forEach(id => {
            $(id).addEventListener('change', () => {
                updateVehicleImages();
                recalc();
            });
        });

        $('homeChargePct').addEventListener('input', recalc);
    </script>
</body>
</html>
